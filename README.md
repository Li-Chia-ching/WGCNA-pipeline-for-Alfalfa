# WGCNA Analysis Pipeline for *Medicago sativa*

**Current Version:** Advanced Analysis v2.7.1 | Basic Script v1.1.0  
**Author:** Jiaqing Li  
**Date:** December 2025

## Overview

This repository contains a robust, publication-ready R pipeline for **Weighted Gene Co-expression Network Analysis (WGCNA)**. It is specifically optimized for:

1.  **System Constraints:** Optimized for 16GB RAM environments using memory-aware data handling.
2.  **Target Species:** tailored for *Medicago sativa* (Alfalfa), addressing the lack of specific annotation packages by implementing strict external validation workflows.
3.  **Scientific Integrity:** Enforces strict data handling standards, ensuring all visualizations are derived from real experimental data.

-----

## ğŸš€ Key Features

  * **Automated Environment Setup:** Auto-detection and retry logic for installing CRAN and Bioconductor packages (configured for Tsinghua mirrors).
  * **Strict Quality Control:**
      * Filters genes with \>50% zero expression.
      * Removes the bottom 25% of genes with low variance to reduce noise.
  * **Robust Network Construction:** Uses `blockwiseModules` with multi-threading (6 threads) to handle large datasets efficiently.
  * **Hub Gene Identification:** Implements **kME ranking** (Module Eigengene Connectivity) to identify the top 10% most connected genes, ensuring robust Cytoscape network generation.
  * **Publication-Quality Visualizations:** Generates dendrograms, heatmaps, and topology plots using `ggplot2` and `pheatmap`.

-----

## ğŸ›  System Requirements

  * **OS:** Windows 10/11 (Tested). Compatible with Linux/macOS with path adjustments.
  * **R Version:** R 4.5.2 or higher.
  * **Hardware:**
      * **CPU:** Multi-core processor (Pipeline uses 6 threads).
      * **RAM:** 16GB minimum recommended.

-----

## ğŸ“¦ Installation

Copy and paste the following code into your R console to initialize the environment and install all dependencies:

```r
# 1. Set Mirrors
options(repos = c(CRAN = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/"))
options(BioC_mirror = "https://mirrors.tuna.tsinghua.edu.cn/bioc/")

# 2. Install Core Packages
install.packages(c("WGCNA", "dplyr", "ggplot2", "reshape2", 
                   "stringr", "RColorBrewer", "BiocManager", 
                   "pheatmap", "igraph", "patchwork"))

# 3. Install Bioconductor Dependencies
BiocManager::install(c("GO.db", "impute", "preprocessCore", "clusterProfiler"))
```

-----

## ğŸ“‚ Output Directory Structure

The pipeline automatically creates the following directory structure:

```text
Project_Root/
â”œâ”€â”€ 01_InputData/          # Preprocessed expression matrices & QC stats
â”œâ”€â”€ 02_QC/                 # Sample clustering & Soft-thresholding plots
â”œâ”€â”€ 03_Network/            # RData objects (net, MEs) and TOM matrices
â”œâ”€â”€ 04_Modules/            # Module-trait relationships & Eigengene heatmaps
â”œâ”€â”€ 05_Results/            # Basic Results
â”‚   â”œâ”€â”€ Cytoscape_Networks/ # Edges/Nodes files for Cytoscape (Top 10% kME)
â”‚   â”œâ”€â”€ Gene_Module_Assignments_Full.csv
â”‚   â””â”€â”€ Module_Eigengenes_Expression.csv
â””â”€â”€ 06_Advanced_Results/   # (Generated by v2.7.1 script)
    â”œâ”€â”€ Figures/           # High-res PDFs (Heatmaps, Networks, Topologies)
    â”œâ”€â”€ Enrichment/        # Gene lists for AgriGO/EggNOG & Analysis Guides
    â”œâ”€â”€ Tables/            # Correlation matrices
    â””â”€â”€ Network_Data/      # Hub gene lists
```

-----

## ğŸ“ Change Log & Version History

### v2.7.1 - The Robustness Patch (Current)

*Release Date: Dec 2025*

**Summary:** A non-critical patch improving the robustness of the **Module Correlation Heatmap** generation.

  * **Issue Resolved:** Addressed edge cases where specific data normalization resulted in identical variance across Module Eigengenes (MEs), causing `min/max of all NA` warnings in the `cor` function.
  * **Impact:**
      * **User Experience:** Eliminates confusing console warnings.
      * **Scientific Validity:** Zero impact on biological conclusions. Module detection, hub gene identification, and enrichment preparations remain identical to v2.7.
  * **Action:** If you are running v2.7 successfully, no update is needed. This patch is for users experiencing console warnings during heatmap generation.

### v2.7 - The Integrity & Optimization Update

  * **Refactor: Academic Integrity:**
      * **Removed Synthetic Data:** Completely removed code that generated random/placeholder functional category pie charts.
      * **New Workflow:** Added `Enrichment_Analysis_Guide.txt` and `Visualization_Template.R` to guide users in performing *real* external enrichment analysis (using AgriGO, EggNOG-mapper).
  * **Refactor: Network Robustness:**
      * **Dynamic Thresholding:** Replaced fixed edge thresholds (0.6) with dynamic quantile thresholding (Top 10% / 90th percentile). This ensures Cytoscape networks are always generated, regardless of overall module correlation strength.
  * **Optimization:** Enhanced memory monitoring for 16GB RAM systems.

### v1.1.0 - Basic Pipeline

  * Initial release of the standard WGCNA workflow.
  * Includes robust data cleaning (50% zeros / 25% variance filtering).
  * Includes basic Cytoscape export functionality.

-----

## ğŸ”¬ Scientific Integrity Statement

**Strict Data Policy:**
This pipeline is designed to adhere to the highest standards of scientific data integrity.

1.  **No Synthetic Data:** All visualizations (heatmaps, dendrograms, networks) are generated directly from your provided expression data.
2.  **Enrichment Analysis:** Due to the lack of a standardized `OrgDb` for *Medicago sativa*, this pipeline **does not** perform internal "guesswork" enrichment. Instead, it exports precise gene lists and provides a guide for using established external tools (AgriGO v2, EggNOG-mapper) to ensuring valid biological interpretation.

-----

## ğŸ“– Usage Guide

1.  **Prepare Data:** Ensure your input file is a standard CSV/TXT expression matrix.
2.  **Run Basic Script (v1.1.0):** Executes data cleaning, network construction, and module identification.
      * *Output:* `03_Network/WGCNA_Network_Object.RData`.
3.  **Run Advanced Script (v2.7.1):** Loads the network object to perform visualization, hub gene mining, and generate enrichment lists.
      * *Output:* Publication-ready figures in `06_Advanced_Results/`.
4.  **External Validation:** Use the files in `06_Advanced_Results/Enrichment/` to perform GO/KEGG analysis using the `mtr` (Medicago truncatula) database as a reference.
